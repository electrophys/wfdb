= WAVE User's Guide
George B. Moody
:toc: left
:toclevels: 3
:icons: font

== Introducing WAVE

WAVE is a graphical waveform viewer, annotation editor, and analysis tool
for WFDB records.  Built with GTK 3 and Cairo, it provides calibrated
signal display, interactive annotation editing, and an embedded terminal
for running analysis commands.

=== Getting Started

To open a WFDB record:

----
wave -r 100s
----

This opens record `100s` (a one-minute sample record included with the
WFDB Software Package) in the WAVE main window.

To open a record with its reference annotations:

----
wave -r 100s -a atr
----

The main window shows the signal waveforms with annotations displayed
above them.  The status bar at the bottom shows the current record name,
time, and signal information.

=== The Main Window

The WAVE main window consists of:

* A *toolbar* at the top with navigation and control buttons
* The *signal display area* showing waveforms drawn with Cairo
* A *status bar* at the bottom showing the current position

The signal display uses calibrated scales.  The default time scale is
25 mm/sec and the default amplitude scale is 10 mm/mV, matching standard
ECG paper.

=== Navigation

Use these controls to move through a record:

* *<* and *>* buttons: move backward/forward by half a screen
* *<<* and *>>* buttons: move backward/forward by a full screen
* *|<* and *>|* buttons: jump to the beginning/end of the record
* *Find* button: search for annotations matching the search template
* Keyboard shortcuts (see <<Keyboard Commands and Mouse Actions>>)

=== Opening Multiple Records

You can view multiple records simultaneously by joining record names
with `+`:

----
wave -r 100+100 -a atr
----

This opens separate WAVE windows for each record.  The last window
is the _master_ window, which has a *Sync* button to synchronize
all windows to the same time position.

Use the `+__n__/` prefix to apply options to a specific window:

----
wave -r 100+100 -a +0/atr +1/qrs
----

This opens record 100 twice, with annotator `atr` in window 0 and
annotator `qrs` in window 1.


== Annotation Editing

WAVE provides interactive annotation editing capabilities.  To enable
editing, use the *Edit* menu or toolbar button.

=== Selecting Annotations

* Click the *left mouse button* in the signal window to select the
  nearest annotation to the left of the pointer
* Click the *right mouse button* to select the nearest annotation to the
  right
* Use the *left arrow* and *right arrow* keys

The selected annotation is highlighted and its details appear in the
Annotation Template panel.

=== Inserting Annotations

. Set the annotation type in the Annotation Template panel (use
  single-character mnemonics or select from the Type menu)
. Position the crosshair pointer at the desired location in the signal
  window
. Click the *middle mouse button* or press *F2* to insert the annotation

=== Moving Annotations

* Select an annotation, then press *F3* (move left) or *F4* (move right)
  to shift it
* In multi-edit mode (annotations attached to signals), use the *up* and
  *down arrow* keys to change the signal attachment (the `chan` field)

=== Deleting Annotations

Select an annotation, then press the *Delete* key to remove it.

=== Changing Annotation Types

. Select the annotation
. Press *F6* to copy it to the Annotation Template
. Change the type in the template
. Click the middle button or press *F2* at the same location

=== Saving Annotations

Select *Save* from the *File* menu to write edited annotations.
WAVE writes annotation files to the current working directory.

IMPORTANT: If you are editing annotations and wish to reopen them later,
make sure the current directory is the first directory in your WFDB path.


== Analyzing Data with WAVE

WAVE includes an embedded VTE terminal for running analysis commands
and a configurable menu system for launching common operations.

=== The Analysis Window

The Analysis window contains:

* A row of command buttons defined by the menu file
* Start and end time fields for selecting analysis intervals
* Signal selection controls
* An embedded terminal emulator (VTE) for command output

To select an analysis interval, set the start and end times using the
controls, or use the signal window: the left edge becomes `$START` and
the right edge becomes `$RIGHT`.

=== Menu Files

Analysis commands are defined in a menu file.  Each line has the format:

----
Label<TAB>Command
----

where `<TAB>` is one or more tab characters.  Lines beginning with `#` and
blank lines are ignored.

WAVE searches for menu files in this order:

. The file specified by the `WAVEMENU` environment variable
. `wavemenu` in the current directory
. `$MENUDIR/wavemenu.def` (default menu)

The default menu includes commands for QRS detection, calibration,
segment extraction, and printing.

=== Menu Variables

Before executing a command, WAVE replaces these tokens:

[cols="1,3"]
|===
|Token |Replacement

|`$RECORD` |Current record name
|`$ANNOTATOR` |Current input annotator
|`$START` |Selected start time
|`$END` |Selected end time
|`$DURATION` |Duration ($END - $START)
|`$LEFT` |Left edge of signal window
|`$RIGHT` |Right edge of signal window
|`$WIDTH` |Width of signal window ($RIGHT - $LEFT)
|`$SIGNAL` |Currently selected signal number
|`$SIGNALS` |Current signal list
|`$LOG` |Current log file name
|`$WFDB` |WFDB path
|`$WFDBCAL` |WFDB calibration file name
|`$TSCALE` |Time scale (mm/sec)
|`$VSCALE` |Amplitude scale (mm/mV)
|`$DISPMODE` |Annotation display mode
|`$PSPRINT` |PostScript print command
|`$TEXTPRINT` |Text print command
|`$URL` |URL from most recently selected link annotation
|===

Other tokens beginning with `$` are passed to the shell unchanged.

=== The Embedded Terminal

The Analysis Commands window contains a VTE terminal emulator running
your shell (as set by the `SHELL` environment variable, defaulting to
`/bin/sh`).  You can type commands directly into this terminal or use the
menu buttons to run predefined commands.  Output appears in real-time.


== Printing from WAVE

WAVE can generate PostScript output using `pschart` and `psfd`.

=== Chart Strips

Use *Print chart* from the analysis menu (or define your own command)
to generate chart-strip style output:

----
echo $RECORD $START-$END | pschart -a $ANNOTATOR -g -l -R -s $SIGNALS - | $PSPRINT
----

=== Full Disclosure

Use *Print full disclosure* for a condensed multi-line display:

----
echo $RECORD $START-$END | psfd -a $ANNOTATOR -g -l -R -s $SIGNALS - | $PSPRINT
----

=== Print Setup

The `PSPRINT` and `TEXTPRINT` environment variables control the print
commands.  If not set, WAVE uses `lpr -P$PRINTER`.


== Calibration

WAVE uses the WFDB calibration database to properly scale signal
displays.  The calibration file (specified by the `WFDBCAL` environment
variable) contains entries that map signal types to physical units.

To calibrate signals interactively, use the *Calibrate* command in the
analysis menu, which runs `calsig`:

----
calsig -r $RECORD -f $START -t $END -s $SIGNALS
----

This adjusts the gain and baseline values in the header file to match
the actual signal characteristics.  See link:../wag/calsig.1.html[calsig(1)]
for details.


== Customizing WAVE

=== Preferences File

WAVE stores user preferences in `~/.config/wave/waverc`, using the
GKeyFile (INI-style) format.  The directory is created automatically
if needed.

Use *Save as new defaults* in the View window to save your current
display settings.

.Example `~/.config/wave/waverc`
----
[Wave]
Dpi=96.0x96.0
SignalWindow.Height_mm=120
SignalWindow.Width_mm=250
SignalWindow.Font=Monospace 10
Color.Background=white
Color.Grid=#E5E5E5
Color.GridCoarse=#CCCCCC
Color.Cursor=OrangeRed
Color.Annotation=YellowGreen
Color.Signal=blue
Color.Highlight=OrangeRed
View.TimeScale=12
View.AmplitudeScale=3
View.GridMode=3
View.SignalNames=true
View.Markers=true
----

=== Preference Keys

[cols="2,1,3"]
|===
|Key |Default |Description

|`Dpi` |_(auto-detected)_ |Display resolution (WxH)
|`SignalWindow.Height_mm` |120 |Window height in mm
|`SignalWindow.Width_mm` |250 |Window width in mm
|`SignalWindow.Font` |Monospace 10 |Font for annotations and time marks
|`Color.Background` |white |Signal window background
|`Color.Grid` |#E5E5E5 |Fine grid color
|`Color.GridCoarse` |#CCCCCC |Coarse grid color
|`Color.Cursor` |OrangeRed |Cursor/marker bar color
|`Color.Annotation` |YellowGreen |Annotation text color
|`Color.Signal` |blue |Signal waveform color
|`Color.Highlight` |OrangeRed |Highlight color
|`View.Subtype` |false |Show annotation subtyp
|`View.Chan` |false |Show annotation chan
|`View.Num` |false |Show annotation num
|`View.Aux` |false |Show annotation aux
|`View.Markers` |false |Show annotation marker bars
|`View.SignalNames` |false |Show signal names
|`View.Baselines` |false |Show DC baselines
|`View.Level` |false |Show level tracking
|`View.TimeScale` |12 |Time scale index (12 = 25 mm/sec)
|`View.AmplitudeScale` |3 |Amplitude scale index (3 = 10 mm/mV)
|`View.AnnotationMode` |0 |0=centered, 1=attached, 2=as signal
|`View.SignalMode` |0 |0=all signals, 1=listed only
|`View.TimeMode` |0 |0=elapsed, 1=absolute, 2=samples
|`View.GridMode` |3 |0=none, 1=time, 2=amplitude, 3=both
|===

Colors may be specified using any format accepted by `gdk_rgba_parse()`:
named colors (e.g., `blue`, `OrangeRed`), hex values (e.g., `#FF0000`,
`#E5E5E5`), or `rgb()` / `rgba()` notation.

=== Custom Annotation Types

WAVE can use custom annotation definitions loaded from a file specified by
the `ANNTAB` environment variable.  The file contains one entry per line:

----
15 % Funny looking beat
----

where the first field is the numeric annotation code (1 to ACMAX), the
second field is the mnemonic character, and the remainder is a description.
Lines beginning with `#` are comments.

=== The Text Editor

WAVE uses the program specified by the `EDITOR` environment variable for
editing menu files and log files.  If `EDITOR` is not set, WAVE uses
`xdg-open`, which opens the file with the system's default text editor.


== Summary of WAVE Controls

=== Toolbar Buttons

[cols="1,3"]
|===
|Button |Action

|*|<* |Jump to beginning of record
|*<<* |Move back one full screen
|*<* |Move back half a screen
|*>* |Move forward half a screen
|*>>* |Move forward one full screen
|*>|* |Jump to end of record
|*Find* |Search for matching annotation
|*Sync* |Synchronize all windows (master window only)
|===

=== View Window Controls

The View window allows you to adjust:

* *Time scale*: 0.25 mm/hour to 500 mm/ms (26 settings)
* *Amplitude scale*: 1 mm/mV to 100 mm/mV (7 settings)
* *Draw mode*: all signals or listed signals only
* *Annotation display*: centered, attached to signals, or as a signal
* *Time display*: elapsed time, absolute time, or sample intervals
* *Grid*: none, time only, amplitude only, or both
* Toggles for showing subtypes, chan, num, aux, markers, signal names,
  baselines, and level tracking
* *Save as new defaults*: saves current settings to `~/.config/wave/waverc`

=== Scope Window

The Scope window displays a close-up, auto-scrolling view of the signal
at the current annotation position.


== System Requirements

WAVE requires:

* *GTK 3* (3.20 or later recommended)
* *Cairo* (included with GTK 3)
* *VTE* (libvte-2.91) for the embedded terminal
* A POSIX-compatible operating system (GNU/Linux, macOS, FreeBSD, etc.)

WAVE runs natively on any system with a GTK 3 display server (X11 or
Wayland).

=== Display Resolution

WAVE automatically detects the display resolution using GDK.  If the
detected resolution is incorrect (causing inaccurate grid spacing or
signal scaling), you can override it with:

* The `-dpi` command-line option: `wave -r 100s -dpi 96x96`
* The `Dpi` key in `~/.config/wave/waverc`


== Setting Up a WAVE Host

=== Installation

WAVE is built automatically as part of the WFDB Software Package if the
required GTK 3 and VTE development libraries are available.

.Debian / Ubuntu
----
sudo apt-get install libgtk-3-dev libvte-2.91-dev
meson setup build
ninja -C build
sudo ninja -C build install
----

.Fedora / RHEL
----
sudo dnf install gtk3-devel vte291-devel
meson setup build
ninja -C build
sudo ninja -C build install
----

The WAVE build can be disabled with `-Dwave=disabled` if GTK 3 is not
available.

=== Remote Access

WAVE can be run remotely over an SSH connection with X11 forwarding:

----
ssh -X hostname wave -r 100s -a atr
----


== Frequently Asked Questions

=== WAVE opens with an empty signal window

This typically indicates a problem with the record path.  Verify that:

* The record exists and is accessible
* The `WFDB` environment variable includes the directory containing
  the record (see link:../wag/setwfdb.1.html[setwfdb(1)])

=== Signals are not scaled correctly

The display resolution may be incorrect.  Use `-dpi` to set the correct
resolution:

----
wave -r 100s -dpi 96x96
----

Or adjust grid squares to 5 mm using the `Dpi` preference.

=== How do I change colors?

Edit `~/.config/wave/waverc` and set the `Color.*` keys, or use
`Save as new defaults` after adjusting settings in the View window.

=== Where are my edited annotations saved?

WAVE writes annotation files to the current working directory.  Make sure
this directory is in your WFDB path if you want to reopen them later.

=== The analysis menu is missing or empty

Check that a `wavemenu` file exists in the current directory or that
`$MENUDIR/wavemenu.def` is installed.  You can also set the `WAVEMENU`
environment variable to point to your menu file.


== Command-Line Options

[cols="1,3"]
|===
|Option |Description

|`-r` _record_[`+`_record_...] |Open the specified record(s)
|`-a` _annotator_ |Open annotation files
|`-dpi` _xx_[`x`_yy_] |Set display resolution (dots/inch)
|`-f` _time_ |Start at the specified time
|`-H` |Use high-resolution mode for multifrequency records
|`-m` |Use monochrome rendering
|`-p` _path_ |Add to the WFDB path
|`-s` _signal_ [...] |Set the initial signal list
|`-Va` |Show annotation aux fields
|`-VA` _n_ |Set annotation display mode
|`-Vb` |Show baselines
|`-Vc` |Show annotation chan fields
|`-VG` _n_ |Set grid mode
|`-Vl` |Show level tracking
|`-Vm` |Show annotation markers
|`-Vn` |Show annotation num fields
|`-VN` |Show signal names
|`-Vs` |Show annotation subtypes
|`-VS` _n_ |Set signal display mode
|`-Vt` _n_ |Set time scale
|`-VT` _n_ |Set time display mode
|`-Vv` _n_ |Set amplitude scale
|===


[[Keyboard Commands and Mouse Actions]]
== Keyboard Commands and Mouse Actions

=== Mouse Actions

[cols="1,3"]
|===
|Action |Result

|Left click in signal window |Select annotation to the left
|Right click in signal window |Select annotation to the right
|Middle click in signal window |Insert annotation (when editing)
|Hold any button |Show crosshair cursor with level tracking (if enabled)
|===

=== Keyboard Commands

These commands are active when the pointer is in the signal window:

[cols="1,3"]
|===
|Key |Action

|Left arrow |Select annotation to the left
|Right arrow |Select annotation to the right
|Up arrow |Move annotation up one signal (multi-edit mode)
|Down arrow |Move annotation down one signal (multi-edit mode)
|F1 |Open context help
|F2 |Insert annotation at pointer position
|F3 |Move pointer left
|F4 |Move pointer right
|F6 |Copy selected annotation to template
|F9 |Search forward
|Ctrl+F9 |Search backward
|End / Shift+F9 |Jump to end of record
|Home / Ctrl+Shift+F9 |Jump to beginning of record
|Page Down / F10 |Advance half a screen
|Ctrl+Page Down / Ctrl+F10 |Advance a full screen
|Page Up / Shift+F10 |Move back half a screen
|Ctrl+Page Up / Ctrl+Shift+F10 |Move back a full screen
|Enter / Return |Open link from selected link annotation
|Any letter or punctuation |Select annotation mnemonic in template
|===


== Environment Variables

[cols="1,1,3"]
|===
|Variable |Default |Description

|`WFDB` |_(builtin path)_ |Database search path
|`WFDBCAL` |_(builtin)_ |Calibration file name
|`WAVEMENU` |`wavemenu` |Analysis menu file
|`SHELL` |`/bin/sh` |Shell for the embedded terminal
|`EDITOR` |`xdg-open` |Text editor for menu/log files
|`PRINTER` |_(system default)_ |Printer name
|`PSPRINT` |`lpr -P$PRINTER` |PostScript print command
|`TEXTPRINT` |`lpr -P$PRINTER` |Text print command
|`ANNTAB` |_(none)_ |Custom annotation definitions file
|`MENUDIR` |`/usr/local/lib` |Default menu file directory
|===
